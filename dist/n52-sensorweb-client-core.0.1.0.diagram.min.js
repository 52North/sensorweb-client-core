/*! n52-sensorweb-client-core.0.1.0 2015-09-13 17:41 */
angular.module("diagramModule",["timeseriesModule","timeModule","flotModule","timeSelectorButtonsModule","settingsModule","yAxisHideModule"]).controller("chartController",["$scope","timeseriesService","timeService","diagramBehaviourService","$log","$rootScope","settingsService",function(a,b,c,d,e,f,g){function h(){a.options.xaxis.min=c.time.start.toDate().getTime(),a.options.xaxis.max=c.time.end.toDate().getTime()}function i(b){a.options.yaxes=j(b)}function j(a){var b={};angular.forEach(a,function(a){void 0===a.styles.groupedAxis||a.styles.groupedAxis?b.hasOwnProperty(a.uom)?(b[a.uom].tsColors.push(a.styles.color),a.styles.yaxis=b[a.uom].id):(b[a.uom]={id:++Object.keys(b).length,uom:a.uom,tsColors:[a.styles.color],zeroScaled:a.styles.zeroScaled},a.styles.yaxis=b[a.uom].id):(b[a.id]={id:++Object.keys(b).length,uom:a.uom+" @ "+a.station.properties.label,tsColors:[a.styles.color],zeroScaled:a.styles.zeroScaled},a.yaxis=b[a.id].id)});var c=[];return angular.forEach(b,function(a){c.splice(a.id-1,0,{uom:a.uom,tsColors:a.tsColors,min:a.zeroScaled?0:k.yaxis.min})}),c}e.info("start chart controller");var k={series:{downsample:{threshold:0},lines:{show:!0,fill:!1},shadowSize:1},selection:{mode:"xy"},grid:{hoverable:!0,autoHighlight:!1},crosshair:{mode:"x"},xaxis:{mode:"time",timezone:"browser"},yaxis:{show:!0,additionalWidth:17,panRange:!1,min:null,labelWidth:50},legend:{show:!1},pan:{interactive:!0,frameRate:10}};angular.merge(k,g.chartOptions),a.timeseries=b.timeseries,a.behaviour=d.behaviour,a.options=k,h(),f.$on("timeExtentChanged",function(a,b){h()}),a.$watch("timeseries",i,!0),a.$watch("behaviour",function(b){a.options.yaxis.show=b.showYAxis},!0),e.info("end chart controller")}]).factory("diagramBehaviourService",function(){function a(){b.showYAxis=!b.showYAxis}var b={};return b.showYAxis=!0,{behaviour:b,toggleYAxis:a}}),angular.module("flotModule",["timeModule","barChartModule"]).directive("flot",["timeService","$window","$log","flotService","$translate","timeseriesService","styleService",function(a,b,c,d,e,f,g){function h(b,c){var d=c.getXAxes()[0],e=moment(d.min),f=moment(d.max);a.setFlexibleTimeExtent(e,f)}return{restrict:"EA",template:"<div></div>",scope:{dataset:"=",options:"=",callback:"="},link:function(a,c,i){var j,k,l,m,n,o,p,q;if(l=null,n=i.width||"100%",j=i.height||"100%",(null!==(o=a.options)&&null!==(p=o.legend)?p.container:void 0)instanceof jQuery)throw'Please use a jQuery expression string with the "legend.container" option.';q||(q=d.createDataSet()),a.options||(a.options={legend:{show:!1}}),m=$(c.children()[0]),m.css({width:n,height:j}),$(m).bind("plotpanEnd",h),a.$on("timeseriesChanged",function(a,b){d.updateTimeseriesInDataSet(q,b),initNewPlot()}),a.$on("allTimeseriesChanged",function(a){d.updateAllTimeseriesToDataSet(q),initNewPlot()}),a.$on("timeseriesDataChanged",function(a,b){d.updateTimeseriesInDataSet(q,b),initNewPlot()}),initNewPlot=function(){if(0!==q.length){var b=$.plot(m,q,a.options);return createPlotAnnotation(),createYAxis(b),b}},createPlotAnnotation=function(){m.append("<div class='chart-annotation'>"+e.instant("chart.annotation")+"</div>")},createYAxis=function(a){$(".yaxisLabel").remove(),$.each(a.getAxes(),$.proxy(function(b,c){if(c.show){var d=c.box;if("y"===c.direction){$("<div class='axisTarget' style='position:absolute; left:"+d.left+"px; top:"+d.top+"px; width:"+d.width+"px; height:"+d.height+"px'></div>").data("axis.n",c.n).appendTo(a.getPlaceholder()).click($.proxy(function(b){var c=$(b.currentTarget),d=!1;$.each($(".axisTarget"),function(a,b){return b=$(b),c.data("axis.n")===b.data("axis.n")?(d=b.hasClass("selected"),!1):void 0}),$.each(a.getData(),function(a,b){var e=f.getTimeseries(b.id);c.data("axis.n")===b.yaxis.n?g.setSelection(e,!d,!0):g.setSelection(e,!1,!0)}),d||c.addClass("selected"),g.notifyAllTimeseriesChanged()},this));var e=$("<div class='axisLabel yaxisLabel' style=left:"+d.left+"px;></div>").text(c.options.uom).appendTo("#placeholder");c.options.tsColors&&$.each(c.options.tsColors,function(a,b){$("<span>").html("&nbsp;&#x25CF;").css("color",b).addClass("labelColorMarker").appendTo(e)}),e.css("margin-left",-(e.width()-e.height())/2-3)}}},this)),$.each(a.getData(),function(a,b){b.selected&&$.each($(".axisTarget"),function(){return $(this).data("axis.n")!==b.yaxis.n||$(this).hasClass("selected")?void 0:($(this).addClass("selected"),!1)})})},k=function(){d.updateAllTimeseriesToDataSet(q),l=initNewPlot()},a.$watch("options",k,!0),angular.element(b).bind("resize",initNewPlot)}}}]).factory("flotService",["timeseriesService","settingsService","barChartHelperService",function(a,b,c){return updateAllTimeseriesToDataSet=function(b){angular.forEach(a.getAllTimeseries(),function(a){updateTimeseriesInDataSet(b,a.internalId)})},updateTimeseriesInDataSet=function(a,b){removeTimeseriesFromDataSet(a,b),addTimeseriesToDataSet(a,b)},addTimeseriesToDataSet=function(b,c){if(a.isTimeseriesVisible(c)){var d=a.getData(c),e=a.getTimeseries(c);if(d&&d.values){var f=createEntry(e,d);b.push(f)}angular.forEach(a.getTimeseries(c).referenceValues,function(d){if(d.visible){var e=a.getData(c);e&&e.referenceValues&&b.push({id:d.referenceValueId,color:d.color,data:a.getData(c).referenceValues[d.referenceValueId]})}})}},createEntry=function(a,d){var e={id:a.internalId,color:a.styles.color,data:d.values,selected:a.styles.selected,lines:{lineWidth:a.styles.selected?b.selectedLineWidth:b.commonLineWidth},bars:{lineWidth:a.styles.selected?b.selectedLineWidth:b.commonLineWidth},yaxis:a.styles.yaxis};if(a.renderingHints&&a.renderingHints.chartType&&"bar"===a.renderingHints.chartType){var f=a.renderingHints.properties.interval;e.bars={show:!0,barWidth:60*c.intervalToHour(f)*60*1e3},e.lines={show:!1},e.data=c.sumForInterval(d.values,f)}else e.data=d.values;return e},createDataSet=function(){var b=[];return a.getTimeseriesCount()>0&&angular.forEach(a.timeseries,function(a){addTimeseriesToDataSet(b,a.id)}),b},removeTimeseriesFromDataSet=function(b,c){removeData(b,c),a.getTimeseries(c)&&angular.forEach(a.getTimeseries(c).referenceValues,function(a){removeData(b,a.referenceValueId)})},removeData=function(a,b){var c;angular.forEach(a,function(a,d){a.id===b&&(c=d)}),c>=0&&a.splice(c,1)},{updateTimeseriesInDataSet:updateTimeseriesInDataSet,updateAllTimeseriesToDataSet:updateAllTimeseriesToDataSet,createDataSet:createDataSet}}]),angular.module("yAxisHideModule",["timeseriesModule"]).directive("yAxisHideButton",["diagramBehaviourService",function(a){return{restrict:"E",templateUrl:"templates/diagram/y-axis-hide-button.html",controller:["$scope",function(b){b.behaviour=a.behaviour,b.toggleYAxis=function(){a.toggleYAxis()}}]}}]);