/*! n52-sensorweb-client-core.0.1.0 */
angular.module("n52.core.diagram",["n52.core.time","n52.core.flot","n52.core.timeSelectorButtons","n52.core.settings","n52.core.yAxisHide"]).controller("chartCtrl",["$scope","diagramBehaviourService","flotChartServ",function(a,b,c){a.behaviour=b.behaviour,a.options=c.options,a.dataset=c.dataset,a.$watch("behaviour",function(b){a.options.yaxis.show=b.showYAxis},!0)}]).factory("diagramBehaviourService",function(){function a(){b.showYAxis=!b.showYAxis}var b={};return b.showYAxis=!0,{behaviour:b,toggleYAxis:a}}).factory("flotChartServ",["timeseriesService","timeService","settingsService","flotDataHelperServ","$rootScope",function(a,b,c,d,e){function f(){i.xaxis.min=b.time.start.toDate().getTime(),i.xaxis.max=b.time.end.toDate().getTime()}function g(){var b={};angular.forEach(a.getAllTimeseries(),function(a){void 0===a.styles.groupedAxis||a.styles.groupedAxis?b.hasOwnProperty(a.uom)?(b[a.uom].tsColors.push(a.styles.color),a.styles.yaxis=b[a.uom].id):(b[a.uom]={id:++Object.keys(b).length,uom:a.uom,tsColors:[a.styles.color],zeroScaled:a.styles.zeroScaled},a.styles.yaxis=b[a.uom].id):(b[a.id]={id:++Object.keys(b).length,uom:a.uom+" @ "+a.station.properties.label,tsColors:[a.styles.color],zeroScaled:a.styles.zeroScaled},a.yaxis=b[a.id].id)});var c=[];angular.forEach(b,function(a){c.splice(a.id-1,0,{uom:a.uom,tsColors:a.tsColors,min:a.zeroScaled?0:i.yaxis.min})}),i.yaxes=c}function h(){var b=[];return a.getTimeseriesCount()>0&&angular.forEach(a.timeseries,function(c){d.addTimeseriesToDataSet(b,k,c.id,a.getData(c.id))}),b}var i={series:{downsample:{threshold:0},lines:{show:!0,fill:!1},shadowSize:1},selection:{mode:null},grid:{hoverable:!0,autoHighlight:!1},crosshair:{mode:"x"},xaxis:{mode:"time",timezone:"browser"},yaxis:{show:!0,additionalWidth:17,panRange:!1,min:null,labelWidth:50},legend:{show:!1},pan:{interactive:!0,frameRate:10}};angular.merge(i,c.chartOptions);var j=h(),k={showRefValues:!0,showSelection:!0};return f(),e.$on("timeseriesChanged",function(b,c){g(),d.updateTimeseriesInDataSet(j,k,c,a.getData(c))}),e.$on("allTimeseriesChanged",function(){g(),d.updateAllTimeseriesToDataSet(j,k,a.getAllTimeseries())}),e.$on("timeseriesDataChanged",function(b,c){g(),d.updateTimeseriesInDataSet(j,k,c,a.getData(c))}),e.$on("timeExtentChanged",function(){f()}),{dataset:j,options:i}}]).factory("flotDataHelperServ",["timeseriesService","settingsService","barChartHelperService",function(a,b,c){function d(b,c,d){angular.forEach(d,function(d){e(b,c,d.internalId,a.getData(d.internalId))})}function e(a,b,c,d){h(a,c),f(a,b,c,d)}function f(b,c,d,e){if(a.isTimeseriesVisible(d)){var f=a.getTimeseries(d);if(e&&e.values){var h=g(f,e,c);b.push(h)}c.showRefValues&&angular.forEach(a.getTimeseries(d).referenceValues,function(c){if(c.visible){var e=a.getData(d);e&&e.referenceValues&&b.push({id:c.referenceValueId,color:c.color,data:a.getData(d).referenceValues[c.referenceValueId]})}})}}function g(a,d,e){var f=a.styles.selected&&e.showSelection,g={id:a.internalId,color:a.styles.color,data:d.values,selected:f,lines:{lineWidth:f?b.selectedLineWidth:b.commonLineWidth},bars:{lineWidth:f?b.selectedLineWidth:b.commonLineWidth},yaxis:a.styles.yaxis};if(a.renderingHints&&a.renderingHints.chartType&&"bar"===a.renderingHints.chartType){var h=a.renderingHints.properties.interval;g.bars={show:!0,barWidth:60*c.intervalToHour(h)*60*1e3},g.lines={show:!1},g.data=c.sumForInterval(d.values,h)}else g.data=d.values;return g}function h(b,c){i(b,c),a.getTimeseries(c)&&angular.forEach(a.getTimeseries(c).referenceValues,function(a){i(b,a.referenceValueId)})}function i(a,b){var c;angular.forEach(a,function(a,d){a.id===b&&(c=d)}),c>=0&&a.splice(c,1)}return{updateAllTimeseriesToDataSet:d,updateTimeseriesInDataSet:e}}]),angular.module("n52.core.flot",["n52.core.time","n52.core.barChart"]).directive("flot",["timeService","$window","$translate","timeseriesService","styleService",function(a,b,c,d,e){return{restrict:"EA",template:"<div></div>",scope:{dataset:"=",options:"="},link:function(f,g,h){var i,j,k,l,m,n;if(j=null,l=h.width||"100%",i=h.height||"100%",(null!==(m=f.options)&&null!==(n=m.legend)?n.container:void 0)instanceof jQuery)throw'Please use a jQuery expression string with the "legend.container" option.';f.options||(f.options={legend:{show:!1}}),k=$(g.children()[0]),k.css({width:l,height:i}),initNewPlot=function(a,b,c){if(b&&0!==b.length){var d=$.plot(a,b,c);createPlotAnnotation(),createYAxis(d),setSelection(d,c)}else a.empty(),$(".axisLabel").remove()},setSelection=function(a,b){a&&b.selection.range&&a.setSelection({xaxis:{from:b.selection.range.from,to:b.selection.range.to}},!0)},createPlotAnnotation=function(){k.append("<div class='chart-annotation'>"+c.instant("chart.annotation")+"</div>")},createYAxis=function(a){$(a.getPlaceholder()).find(".yaxisLabel").remove(),$.each(a.getAxes(),$.proxy(function(b,c){if(c.show){var f=c.box;if("y"===c.direction){$("<div class='axisTarget' style='position:absolute; left:"+f.left+"px; top:"+f.top+"px; width:"+f.width+"px; height:"+f.height+"px'></div>").data("axis.n",c.n).appendTo(a.getPlaceholder()).click($.proxy(function(b){var c=$(b.currentTarget),f=!1;$.each($(".axisTarget"),function(a,b){return b=$(b),c.data("axis.n")===b.data("axis.n")?(f=b.hasClass("selected"),!1):void 0}),$.each(a.getData(),function(a,b){var g=d.getTimeseries(b.id);c.data("axis.n")===b.yaxis.n?e.setSelection(g,!f,!0):e.setSelection(g,!1,!0)}),f||c.addClass("selected"),e.notifyAllTimeseriesChanged()},this));var g=$("<div class='axisLabel yaxisLabel' style=left:"+f.left+"px;></div>").text(c.options.uom).appendTo(a.getPlaceholder());c.options.tsColors&&$.each(c.options.tsColors,function(a,b){$("<span>").html("&nbsp;&#x25CF;").css("color",b).addClass("labelColorMarker").appendTo(g)}),g.css("margin-left",-(g.width()-g.height())/2-3)}}},this)),$.each(a.getData(),function(a,b){b.selected&&$.each($(".axisTarget"),function(){return $(this).data("axis.n")!==b.yaxis.n||$(this).hasClass("selected")?void 0:($(this).addClass("selected"),!1)})})},f.$watch("options",function(){initNewPlot(k,f.dataset,f.options)},!0),f.$watch("dataset",function(a,b){initNewPlot(k,f.dataset,f.options)},!0),angular.element(b).bind("resize",function(){initNewPlot(k,f.dataset,f.options)}),$(k).bind("plotpanEnd",function(b,c){var d=c.getXAxes()[0],e=moment(d.min),f=moment(d.max);a.setFlexibleTimeExtent(e,f)}),$(k).bind("plotselected",function(b,c){var d=moment(c.xaxis.from),e=moment(c.xaxis.to);a.setFlexibleTimeExtent(d,e)})}}}]),angular.module("n52.core.overviewDiagram",["n52.core.timeseries","n52.core.time","n52.core.flot","n52.core.timeSelectorButtons","n52.core.settings","n52.core.yAxisHide"]).controller("overviewChartCtrl",["$scope","flotOverviewChartServ",function(a,b){a.options=b.options,a.dataset=b.dataset}]).factory("flotOverviewChartServ",["timeseriesService","timeService","$rootScope","interfaceService","utils","flotDataHelperServ",function(a,b,c,d,e,f){function g(){var a=b.time,c=moment.duration(a.duration).add(a.duration),d=moment(a.start).subtract(c),e=moment(a.end).add(c);k.xaxis.min=d.toDate().getTime(),k.xaxis.max=e.toDate().getTime()}function h(){k.selection.range={from:b.time.start.toDate().getTime(),to:b.time.end.toDate().getTime()}}function i(){angular.forEach(a.timeseries,function(a){j(a.internalId)})}function j(b){var c=a.getTimeseries(b);if(c){var g=k.xaxis.min,h=k.xaxis.max;d.getTsData(c.id,c.apiUrl,e.createRequestTimespan(g,h)).success(function(a){f.updateTimeseriesInDataSet(l,m,c.internalId,a[c.id])})}else f.updateTimeseriesInDataSet(l,m,b)}var k={series:{downsample:{threshold:0},lines:{show:!0,fill:!1},shadowSize:1},selection:{mode:"overview",color:"#718296",shape:"butt",minSize:30},grid:{hoverable:!0,autoHighlight:!1},xaxis:{mode:"time",timezone:"browser"},yaxis:{show:!1},legend:{show:!1}},l=[],m={showRefValues:!1,showSelection:!1};return g(),h(),c.$on("timeseriesChanged",function(a,b){j(b)}),c.$on("allTimeseriesChanged",function(){i()}),c.$on("timeseriesDataChanged",function(a,b){j(b)}),c.$on("timeExtentChanged",function(){g(),h(),i()}),{dataset:l,options:k}}]),function(a){function b(b){function c(a,b){return a.left.x<b&&b<a.left.x+2*a.left.w}function d(a,b){return a.inner.x<b&&b<a.inner.x+a.inner.w}function e(a,b){return a.right.x<b&&b<a.right.x+2*a.right.w}function f(a,b,c){return b-a[c].x}function g(a,b){d(a,b)&&(t.dragging="inner",t.offsetLeft=f(a,b,"inner")),c(a,b)&&(t.dragging="left",t.offsetLeft=f(a,b,"left")),e(a,b)&&(t.dragging="right",t.offsetLeft=f(a,b,"right"))}function h(a){t.dragging&&o(a)}function i(b){if(1===b.which){document.body.focus(),void 0!==document.onselectstart&&null===u.onselectstart&&(u.onselectstart=document.onselectstart,document.onselectstart=function(){return!1}),void 0!==document.ondrag&&null===u.ondrag&&(u.ondrag=document.ondrag,document.ondrag=function(){return!1});var c=n(b.pageX);g(t.slider,c),v=function(a){j(a)},a(document).one("mouseup",v)}}function j(a){return v=null,void 0!==document.onselectstart&&(document.onselectstart=u.onselectstart),void 0!==document.ondrag&&(document.ondrag=u.ondrag),t.dragging=null,o(a),s()?l():(b.getPlaceholder().trigger("plotunselected",[]),b.getPlaceholder().trigger("plotselecting",[null])),!1}function k(){if(!s())return null;if(!t.show)return null;var c={};return a.each(b.getXAxes(),function(a,b){if(b.used){var d=b.c2p(t.start),e=b.c2p(t.end);c.xaxis={from:Math.min(d,e),to:Math.max(d,e)}}}),c}function l(){var a=k();b.getPlaceholder().trigger("plotselected",[a])}function m(a,b,c){return a>b?a:b>c?c:b}function n(a){var c=b.getPlaceholder().offset(),d=b.getPlotOffset();return m(0,a-c.left-d.left,b.width())}function o(a){if(null!==a.pageX){if("left"===t.dragging&&(t.start=n(a.pageX-t.offsetLeft),s()||(t.start=t.end-b.getOptions().selection.minSize)),"right"===t.dragging&&(t.end=n(a.pageX-t.offsetLeft),s()||(t.end=t.start+b.getOptions().selection.minSize)),"inner"===t.dragging){var c=t.end-t.start;t.start=n(a.pageX-t.offsetLeft),t.end=n(a.pageX-t.offsetLeft+c),t.start<=0&&(t.start=0,t.end=t.start+c),t.end>=b.width()&&(t.end=b.width(),t.start=t.end-c)}s()&&b.triggerRedrawOverlay()}}function p(a){t.show&&(t.show=!1,b.triggerRedrawOverlay(),a||b.getPlaceholder().trigger("plotunselected",[]))}function q(a,c){var d,e,f,g,h=b.getAxes();for(var i in h)if(d=h[i],d.direction==c&&(g=c+d.n+"axis",a[g]||1!=d.n||(g=c+"axis"),a[g])){e=a[g].from,f=a[g].to;break}if(a[g]||(d="x"==c?b.getXAxes()[0]:b.getYAxes()[0],e=a[c+"1"],f=a[c+"2"]),null!==e&&null!==f&&e>f){var j=e;e=f,f=j}return{from:e,to:f,axis:d}}function r(a,c){var d,e=b.getOptions();"overview"==e.selection.mode&&(d=q(a,"x"),t.start=d.axis.p2c(d.from),t.end=d.axis.p2c(d.to)),t.show=!0,b.triggerRedrawOverlay(),!c&&s()&&l()}function s(){var a=b.getOptions().selection.minSize;return t.end-t.start>=a}var t={start:-1,end:-1,show:!1},u={},v=null;b.clearSelection=p,b.setSelection=r,b.getSelection=k,b.hooks.bindEvents.push(function(a,b){var c=a.getOptions();null!==c.selection.mode&&(b.mousemove(h),b.mousedown(i))}),b.hooks.drawOverlay.push(function(b,c){if(t.show){var d=b.getPlotOffset(),e=b.getOptions();c.save(),c.translate(d.left,d.top);var f=a.color.parse(e.selection.color);c.strokeStyle=f.scale("a",.8).toString(),c.lineWidth=6,c.lineJoin=e.selection.shape,c.fillStyle=f.scale("a",.4).toString();var g=t.start,h=Math.min(0,b.height())+.5,i=t.end-t.start,j=Math.abs(b.height()-0)-1,k={x:g,y:h,w:5,h:j},l={x:g+i-5,y:h,w:5,h:j},m={x:g,y:h,w:i,h:j};t.slider={left:k,right:l,inner:m},c.fillRect(m.x,m.y,m.w,m.h),c.strokeRect(k.x,k.y,k.w,k.h),c.strokeRect(l.x,l.y,l.w,l.h),c.restore()}}),b.hooks.shutdown.push(function(b,c){c.unbind("mousemove",h),c.unbind("mousedown",i),v&&a(document).unbind("mouseup",v)})}a.plot.plugins.push({init:b,options:{selection:{mode:null,color:"#e8cfac",shape:"round",minSize:5}},name:"selection",version:"1.1"})}(jQuery),angular.module("n52.core.yAxisHide",["n52.core.timeseries"]).directive("yAxisHideButton",["diagramBehaviourService",function(a){return{restrict:"E",templateUrl:"templates/diagram/y-axis-hide-button.html",controller:["$scope",function(b){b.behaviour=a.behaviour,b.toggleYAxis=function(){a.toggleYAxis()}}]}}]);